<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vaccination collège – FAQ</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111b2e; --text:#e8eefc; --muted:#b7c2de;
      --border:rgba(255,255,255,.12); --focus:rgba(120,180,255,.35);
      --chip:rgba(255,255,255,.08); --accent: rgba(255,255,255,.06);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 15% 10%, rgba(90,140,255,.18), transparent 60%),
                  radial-gradient(900px 600px at 85% 30%, rgba(0,220,180,.12), transparent 55%),
                  var(--bg);
      color:var(--text); line-height:1.45;
    }
    .wrap{max-width:980px;margin:0 auto;padding:24px 16px 48px}
    header{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:16px; padding:18px 16px; margin-bottom:14px;
    }
    h1{font-size:20px;margin:0 0 8px 0;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;margin:0}
    .toolbar{display:grid;grid-template-columns:1fr 240px;gap:10px;margin:12px 0 12px}
    .input, select{
      width:100%; background:rgba(255,255,255,.04); border:1px solid var(--border);
      border-radius:12px; padding:12px; color:var(--text); outline:none;
    }
    .input:focus, select:focus{box-shadow:0 0 0 4px var(--focus); border-color: rgba(120,180,255,.45)}
    .pillrow{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .pill{
      border:1px solid var(--border); background:var(--chip); border-radius:999px;
      padding:6px 10px; font-size:12px; color:var(--muted); cursor:pointer; user-select:none;
    }
    .pill.active{color:var(--text); border-color: rgba(120,180,255,.45); box-shadow:0 0 0 3px rgba(120,180,255,.18)}
    .section{margin:18px 0 10px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .section h2{font-size:15px;margin:0}
    .count{font-size:12px;color:var(--muted)}
    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border-radius:16px; overflow:hidden;
    }
    details{border-top:1px solid var(--border)}
    details:first-child{border-top:none}
    summary{list-style:none;cursor:pointer;padding:14px;display:flex;gap:10px;align-items:flex-start}
    summary::-webkit-details-marker{display:none}
    .q{font-weight:650;font-size:14px}
    .chev{margin-left:auto;opacity:.8;transition:transform .15s ease;font-size:14px}
    details[open] .chev{transform:rotate(90deg)}
    .ans{padding:0 14px 14px;color:var(--muted);font-size:13px;white-space:pre-wrap}
    .badge{font-size:11px;border:1px solid var(--border);background:rgba(255,255,255,.035);padding:2px 8px;border-radius:999px;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;width:100%}
    .rtl{direction:rtl;text-align:right}
    .introCard{
      border:1px solid var(--border); background: rgba(255,255,255,.03);
      border-radius:16px; padding:14px; margin: 0 0 14px 0;
    }
    .introTitle{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .introTitle h2{font-size:15px;margin:0}
    .introSig{color:var(--muted);font-size:12px}
    .introText{color:var(--text);font-size:13px;white-space:pre-wrap;margin-top:8px}
    .btnrow{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .btn{
      display:inline-block; text-decoration:none;
      border:1px solid var(--border); background: var(--accent);
      padding:10px 12px; border-radius:12px; color:var(--text); font-size:13px;
    }
    .btn:hover{filter:brightness(1.08)}
    .alert{
      border:1px solid rgba(255,80,80,.35); background: rgba(255,80,80,.08);
      border-radius:14px; padding:12px; color:var(--text); margin: 12px 0;
      font-size:13px;
    }
    @media (max-width:680px){.toolbar{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1 id="pageTitle">Vaccination collège – FAQ</h1>
    <p class="sub" id="pageSub">Introduction officielle + FAQ multilingue</p>

    <div class="toolbar">
      <input id="search" class="input" type="search" placeholder="Rechercher (toutes langues)..." />
      <select id="langSelect" aria-label="Langue"></select>
    </div>

    <div class="pillrow" id="sectionPills"></div>
  </header>

  <div id="intro"></div>
  <div id="content"></div>

  <div id="error" class="alert" style="display:none"></div>
</div>

<script>
(() => {
  const RTL_LANGS = new Set(['ar','ps','ku']);
  let faqData = null;
  let introData = null;

  // ---------- helpers ----------
  const $ = (id) => document.getElementById(id);

  function showError(msg){
    const box = $('error');
    box.style.display = 'block';
    box.textContent = msg;
  }

  function hideError(){
    const box = $('error');
    box.style.display = 'none';
    box.textContent = '';
  }

  async function loadJSON(path){
    const res = await fetch(path, {cache: 'no-store'});
    if(!res.ok) throw new Error(`${path} → HTTP ${res.status}`);
    return await res.json();
  }

  // ---------- rendering ----------
  function renderAll(){
    hideError();
    if(!faqData) return;

    const LANGS = faqData.meta.languages;
    const LABELS = faqData.meta.lang_labels;

    const elTitle = $('pageTitle');
    const elLang  = $('langSelect');
    const elSearch = $('search');
    const elContent = $('content');
    const elPills = $('sectionPills');

    let lang = elLang.value || 'fr';
    let activeSection = window.__activeSection || 'all';
    let query = window.__query || '';

    // init language select once
    if(elLang.options.length === 0){
      LANGS.forEach(code => {
        const opt = document.createElement('option');
        opt.value = code;
        opt.textContent = LABELS[code] || code;
        elLang.appendChild(opt);
      });
      elLang.value = 'fr';
      lang = 'fr';
    }

    // direction
    document.documentElement.dir = RTL_LANGS.has(lang) ? 'rtl' : 'ltr';
    document.body.classList.toggle('rtl', RTL_LANGS.has(lang));

    // title + placeholder
    elTitle.textContent = (faqData.meta.title?.[lang] || faqData.meta.title?.fr || 'FAQ').trim();
    elSearch.placeholder = ({fr:'Rechercher (toutes langues)...', en:'Search (all languages)...', ar:'ابحث (كل اللغات)...', tr:'Ara (tüm diller)...', ps:'لټون (ټولې ژبې)...', ku:'گەڕان (هەموو زمانەکان)...'})[lang] || 'Search...';

    // pills
    elPills.innerHTML = '';
    const allPill = document.createElement('div');
    allPill.className = 'pill' + (activeSection === 'all' ? ' active' : '');
    allPill.textContent = ({fr:'Toutes', en:'All', ar:'الكل', tr:'Hepsi', ps:'ټول', ku:'هەموو'})[lang] || 'All';
    allPill.onclick = () => { window.__activeSection = 'all'; renderAll(); };
    elPills.appendChild(allPill);

    const sectionTitle = (sec) => (sec.title?.[lang] || sec.title?.fr || sec.title?.en || sec.key);

    faqData.sections.forEach(sec => {
      const pill = document.createElement('div');
      pill.className = 'pill' + ((activeSection === sec.key) ? ' active' : '');
      pill.textContent = sectionTitle(sec);
      pill.onclick = () => { window.__activeSection = sec.key; renderAll(); };
      elPills.appendChild(pill);
    });

    // search across all languages
    function isMatch(item, q){
      if(!q) return true;
      const qn = q.toLowerCase();
      let blob = '';
      for(const code of LANGS){
        blob += ' ' + (item.q?.[code] || '');
        blob += ' ' + (item.a?.[code] || '');
      }
      return blob.toLowerCase().includes(qn);
    }

    // content
    const container = document.createElement('div');

    faqData.sections.forEach(sec => {
      if(activeSection !== 'all' && activeSection !== sec.key) return;
      const items = faqData.items.filter(it => it.section === sec.key && isMatch(it, query));
      if(items.length === 0) return;

      const header = document.createElement('div');
      header.className = 'section';
      const h2 = document.createElement('h2');
      h2.textContent = sectionTitle(sec);
      const count = document.createElement('div');
      count.className = 'count';
      count.textContent = items.length + ' item(s)';
      header.appendChild(h2);
      header.appendChild(count);

      const card = document.createElement('div');
      card.className = 'card';

      items.forEach(it => {
        const d = document.createElement('details');
        const s = document.createElement('summary');
        const row = document.createElement('div');
        row.className = 'row';

        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = it.id || '';

        const q = document.createElement('div');
        q.className = 'q';
        q.textContent = (it.q?.[lang] || it.q?.fr || '');

        const chev = document.createElement('div');
        chev.className = 'chev';
        chev.textContent = '›';

        row.appendChild(badge);
        row.appendChild(q);
        row.appendChild(chev);
        s.appendChild(row);

        const a = document.createElement('div');
        a.className = 'ans';
        a.textContent = (it.a?.[lang] || it.a?.fr || '');

        d.appendChild(s);
        d.appendChild(a);
        card.appendChild(d);
      });

      container.appendChild(header);
      container.appendChild(card);
    });

    elContent.innerHTML = '';
    elContent.appendChild(container);

    // intro
    renderIntro(lang);
  }

  function renderIntro(lang){
    const box = $('intro');
    box.innerHTML = '';
    if(!introData) return;

    const title = ({fr:"Message d'information", en:"Information message", ar:"رسالة معلومات", tr:"Bilgilendirme mesajı", ps:"د معلوماتو پیغام", ku:"پەیامی زانیاری"})[lang] || "Info";

    const card = document.createElement('div');
    card.className = 'introCard';

    const top = document.createElement('div');
    top.className = 'introTitle';

    const h2 = document.createElement('h2');
    h2.textContent = title;

    const sig = document.createElement('div');
    sig.className = 'introSig';
    sig.textContent = `${introData.intro.signature} • ${(introData.intro.role?.[lang] || introData.intro.role?.fr || '')}`;

    top.appendChild(h2);
    top.appendChild(sig);

    const text = document.createElement('div');
    text.className = 'introText';
    text.textContent = (introData.intro.text?.[lang] || introData.intro.text?.fr || '');

    const btnrow = document.createElement('div');
    btnrow.className = 'btnrow';

    // online registration
    if(introData.registration?.online?.url){
      const a = document.createElement('a');
      a.className = 'btn';
      a.href = introData.registration.online.url;
      a.target = '_blank';
      a.rel = 'noopener';
      a.textContent = introData.registration.online.label?.[lang] || introData.registration.online.label?.fr || "Inscription en ligne";
      btnrow.appendChild(a);
    }

    // forms
    (introData.resources?.forms || []).forEach(f => {
      const a = document.createElement('a');
      a.className = 'btn';
      a.href = f.url;
      a.target = '_blank';
      a.rel = 'noopener';
      a.textContent = f.label?.[lang] || f.label?.fr || 'Formulaire';
      btnrow.appendChild(a);
    });

    // videos
    (introData.resources?.videos || []).forEach(v => {
      const a = document.createElement('a');
      a.className = 'btn';
      a.href = v.url;
      a.target = '_blank';
      a.rel = 'noopener';
      a.textContent = v.title?.[lang] || v.title?.fr || v.title || 'Vidéo';
      btnrow.appendChild(a);
    });

    // email
    if(introData.contact?.email){
      const a = document.createElement('a');
      a.className = 'btn';
      a.href = `mailto:${introData.contact.email}`;
      a.textContent = introData.contact.email;
      btnrow.appendChild(a);
    }

    card.appendChild(top);
    card.appendChild(text);
    card.appendChild(btnrow);
    box.appendChild(card);
  }

  // ---------- events ----------
  $('langSelect').addEventListener('change', () => renderAll());
  $('search').addEventListener('input', (e) => { window.__query = e.target.value.trim(); renderAll(); });

  // ---------- boot ----------
  (async () => {
    try{
      // IMPORTANT: these files MUST be at repo root with these exact names
      [faqData, introData] = await Promise.all([
        loadJSON('./faq.json'),
        loadJSON('./intro_resources.json')
      ]);
      renderAll();
    }catch(err){
      showError("Erreur de chargement. Vérifiez que faq.json et intro_resources.json sont à la racine du dépôt, et que GitHub Pages est bien activé. Détail: " + err.message);
      console.error(err);
    }
  })();
})();
</script>
</body>
</html>
